# RDF Converter Testing Guide

This directory contains comprehensive tests for the RDF Converter application, focusing on verifying that YARRRML mappings work correctly and generate the expected RDF triples.

## Overview

The testing setup validates:
1. **Template Graph Copying** - Semantic data template graphs are successfully copied to the output
2. **Mapping Rule Application** - Each mapping rule generates triples as expected
3. **Data Format Support** - Both CSVW/RDF and plain JSON data sources work correctly
4. **Default Examples** - The default mapping shown in the UI works reliably

## Test Structure

```
tests/
├── conftest.py                    # Pytest configuration and fixtures
├── test_utils.py                  # Testing utilities and helper functions
├── test_integration_mappings.py  # Main integration tests
├── test_batch_mapping.py         # Legacy batch mapping debug script
├── test_StartForm.py             # UI form tests
├── data/                         # Test data files
│   ├── batch_test/               # Batch/JSON test files
│   │   ├── batch_mapping.yaml    # YARRRML mapping with JSONPath
│   │   └── batch_data.json       # Plain JSON test data
│   └── yarrrmltorml/            # YARRRML to RML conversion tests
└── README.md                     # This file
```

## Prerequisites

### Required Services

The RDF Converter requires two microservices to run:

1. **YARRRML Parser** (port 3001) - Converts YARRRML mappings to RML rules
2. **RML Mapper** (port 4000) - Executes RML rules on data to generate triples

### Installation

```bash
# Install test dependencies
pip install -r tests/requirements.txt

# Or install from main requirements
pip install pytest pytest-logging rdflib pyyaml requests
```

## Running Tests

### Quick Start (Automatic Service Management)

The test suite will automatically start Docker services if they're not running:

```bash
# Run all integration tests
pytest tests/test_integration_mappings.py -v

# Run with detailed logging
pytest tests/test_integration_mappings.py -v -s --log-cli-level=INFO

# Run a specific test
pytest tests/test_integration_mappings.py::test_default_mapping_from_ui -v -s
```

### Manual Service Management

If you prefer to manage services manually:

```bash
# Start services using docker-compose
docker-compose up -d yarrrml-parser rmlmapper

# Wait for services to be ready (check logs)
docker-compose logs -f

# Set environment variables
export YARRRML_URL="http://localhost:3001"
export MAPPER_URL="http://localhost:4000"

# Run tests
pytest tests/test_integration_mappings.py -v
```

### Using Development Docker Compose

```bash
# Use the development compose file
docker-compose -f docker-compose.develop.yml up -d

# Run tests
pytest tests/test_integration_mappings.py -v
```

## Test Descriptions

### `test_default_mapping_from_ui`
**Purpose:** Verify the reference mapping works correctly

**Reference URL:** https://raw.githubusercontent.com/Mat-O-Lab/MapToMethod/refs/heads/main/examples/example-map.yaml

**What it tests:**
- Fetches the reference mapping (from URL or local file if available)
- Applies the mapping to the specified data source
- Verifies template triples are copied (generic check - any namespace works)
- Verifies mapping rules generate triples (no specific URL requirements)
- Checks that at least 50% of rules apply successfully

**Local testing:** You can optionally download the mapping to `tests/data/default_mapping/example-map.yaml` for offline testing

**Expected result:** PASS with triples generated and template copied

---

### `test_batch_mapping_with_json`
**Purpose:** Test JSONPath-based mappings with plain JSON data

**What it tests:**
- Uses the batch mapping test files
- Verifies plain JSON data is processed correctly
- Checks for expected predicates from the Catena-X batch model
- Requires 80% rule coverage

**Expected result:** PASS with high rule coverage

---

### `test_template_copy_verification`
**Purpose:** Verify template graph copying (trivial but important)

**What it tests:**
- Fetches the template/method graph
- Counts triples in template
- Verifies all template triples appear in output
- Ensures output has at least as many triples as the template

**Expected result:** Always PASS - this is the easy part

---

### `test_mapping_rules_generate_triples`
**Purpose:** Verify mapping rules actually generate new triples

**What it tests:**
- Compares template size vs output size
- Calculates triples generated by mapping rules
- Verifies average triples per rule >= 1.0
- Ensures rules aren't just being skipped

**Expected result:** PASS with mapping-generated triples > 0

---

### `test_mapping_coverage_analysis`
**Purpose:** Provide detailed diagnostics about mapping quality

**What it tests:**
- Analyzes coverage percentage
- Counts subjects, predicates, typed entities
- Saves output to file for inspection
- Always passes but provides valuable metrics

**Expected result:** Always PASS with diagnostic info

---

### `test_api_endpoint_create_rdf`
**Purpose:** Verify API response structure

**What it tests:**
- Simulates `/api/createrdf` endpoint call
- Checks response has required fields
- Validates response structure

**Expected result:** PASS with valid API response

## Test Markers

Tests are marked with pytest markers for selective execution:

```bash
# Run only integration tests
pytest -m integration

# Run only tests requiring network
pytest -m requires_network

# Run only slow tests
pytest -m slow

# Skip slow tests
pytest -m "not slow"
```

## Understanding Test Results

### Success Criteria

A mapping test is considered successful when:

1. **Rules Applied** - At least one mapping rule generates triples
2. **Template Copied** - Template graph triples are present in output
3. **Mapping Triples** - New triples are generated beyond the template
4. **Coverage** - Specified percentage of rules apply successfully

### Example Output

```
==================== MAPPING TEST SUMMARY ====================
Success: ✓
Total Rules: 11
Rules Applied: 9
Rules Skipped: 2
Total Triples Generated: 156
Rule Coverage: 81.8%
Template Triples Found: ✓
Mapping Triples Found: ✓
==============================================================
```

### Common Failure Reasons

| Issue | Cause | Solution |
|-------|-------|----------|
| No triples generated | RML mapper not running or JSONPath issue | Check Docker services, verify iterator paths |
| Template triples missing | Template URL incorrect or fetch failed | Verify template URL in mapping file |
| Low rule coverage | Data doesn't match mapping conditions | Check data structure matches expected format |
| Services not ready | Docker containers still starting | Wait longer or check container logs |

## Debugging Failed Tests

### Enable Debug Logging

```bash
# Maximum verbosity
pytest tests/test_integration_mappings.py -v -s --log-cli-level=DEBUG

# Save logs to file
pytest tests/test_integration_mappings.py -v -s --log-cli-level=DEBUG 2>&1 | tee test_debug.log
```

### Inspect Generated Output

Tests save output to `tests/data/batch_test/test_output.ttl`:

```bash
# View the generated RDF
cat tests/data/batch_test/test_output.ttl

# Count triples
grep -c "^\s*[^#@].*\.$" tests/data/batch_test/test_output.ttl
```

### Check Service Health

```bash
# Check YARRRML Parser
curl http://localhost:3001/

# Check RML Mapper
curl http://localhost:4000/

# View service logs
docker-compose logs yarrrml-parser
docker-compose logs rmlmapper
```

### Manual Testing

Use the legacy debug script for detailed output:

```bash
# Set environment variables
export YARRRML_URL="http://localhost:3001"
export MAPPER_URL="http://localhost:4000"

# Run debug script
python tests/test_batch_mapping.py
```

## Creating New Tests

### Test Template

```python
@pytest.mark.integration
def test_my_custom_mapping(app_context, test_data_dir):
    """Test description"""
    
    # Setup
    mapping_url = f"file://{test_data_dir}/my_test/mapping.yaml"
    data_url = f"file://{test_data_dir}/my_test/data.json"
    
    # Execute
    filename, output, num_rules, num_applied = apply_mapping(
        mapping_url=mapping_url,
        opt_data_url=data_url,
        authorization=None
    )
    
    # Parse and verify
    graph = parse_rdf_output(output)
    
    # Get template URL
    mapping_data, _ = open_file(mapping_url)
    mapping_dict = yaml.safe_load(mapping_data)
    template_url = mapping_dict["prefixes"]["method"].strip("/")
    
    # Verify results
    template_found = verify_template_triples(graph, template_url)
    mapping_found = verify_mapping_triples(graph)
    
    result = MappingTestResult(
        success=num_applied > 0 and len(graph) > 0,
        num_rules=num_rules,
        num_triples=len(graph),
        num_rules_applied=num_applied,
        num_rules_skipped=num_rules - num_applied,
        output_graph=output,
        template_triples_found=template_found,
        mapping_triples_found=mapping_found
    )
    
    # Assert with custom criteria
    assert_mapping_success(
        result,
        min_coverage_percent=70.0,
        require_template_triples=True,
        require_mapping_triples=True
    )
```

### Adding Test Data

1. Create a directory under `tests/data/`
2. Add your YARRRML mapping file (`.yaml`)
3. Add your data file (`.json`, `.ttl`, etc.)
4. Add a fixture in `conftest.py` if needed

## Continuous Integration

### GitHub Actions Example

```yaml
name: Run Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest
      
      - name: Start Docker services
        run: docker-compose up -d yarrrml-parser rmlmapper
      
      - name: Wait for services
        run: sleep 10
      
      - name: Run tests
        env:
          YARRRML_URL: http://localhost:3001
          MAPPER_URL: http://localhost:4000
        run: pytest tests/test_integration_mappings.py -v
      
      - name: Stop services
        run: docker-compose down
```

## Troubleshooting

### "Docker services could not be started"

**Problem:** Tests skip with message about Docker services

**Solutions:**
1. Ensure Docker is running: `docker ps`
2. Manually start services: `docker-compose up -d`
3. Check port conflicts: `netstat -an | grep 3001` and `netstat -an | grep 4000`

### "No triples generated"

**Problem:** Mapping runs but produces zero triples

**Solutions:**
1. Check RML mapper logs: `docker-compose logs rmlmapper`
2. Verify JSONPath iterators match data structure
3. Ensure data format is correctly detected
4. Check mapping conditions match data values

### "Template triples not found"

**Problem:** Template not copied to output

**Solutions:**
1. Verify template URL is accessible
2. Check template file format
3. Ensure no network issues fetching template
4. Review app logs for parsing errors

### Tests hang or timeout

**Problem:** Tests don't complete

**Solutions:**
1. Increase timeout in conftest.py
2. Check if services are responding: `curl http://localhost:3001/`
3. Restart Docker services
4. Check for deadlocks in application code

## Additional Resources

- [YARRRML Specification](https://rml.io/yarrrml/)
- [RML Specification](https://rml.io/specs/rml/)
- [RDFLib Documentation](https://rdflib.readthedocs.io/)
- [Pytest Documentation](https://docs.pytest.org/)

## Support

For issues or questions:
1. Check this README
2. Review test output and logs
3. Inspect generated RDF files
4. Check Docker service logs
5. Open an issue on the project repository
