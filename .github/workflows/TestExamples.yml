name: TestExamples

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  WORKING_DIR: ./examples
  MAPPING_URL: https://github.com/Mat-O-Lab/MapToMethod/raw/main/examples/example-map.yaml
  APP_MODE: development
  APP_PORT: 5003
  SSL_VERIFY: "False"

jobs:
  TestExamples:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run app (Docker Compose)
        run: |
          docker compose -f docker-compose.develop.yml up -d --build
          echo "Waiting for services to start..."
          sleep 30
          docker compose ps

      - name: Parse mapping to YARRRML parser
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          curl -s -X POST "http://localhost:${APP_PORT}/api/yarrrmltorml" \
            -H "Content-Type: application/json" \
            -d "{\"mapping_url\":\"${MAPPING_URL}\"}" \
            -o example.rml

      - name: Join the method and the data meta graph
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          RESULT=$(curl -s -X POST "http://localhost:${APP_PORT}/api/createrdf" \
            -H "Content-Type: application/json" \
            -d "{\"mapping_url\":\"${MAPPING_URL}\"}")

          echo "$RESULT" | jq -r '.graph' > example.rdf

      - name: Print logs
        if: always()
        run: docker compose logs

      - name: Commit generated files
        uses: EndBug/add-and-commit@v9
        with:
          message: "updated example output"
          add: |
            example.rml
            example.rdf
          cwd: ./examples
