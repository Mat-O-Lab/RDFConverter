name: TestExamples

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  WORKING_DIR: ./examples
  MAPPING_URL: https://github.com/Mat-O-Lab/MapToMethod/raw/main/examples/example-map.yaml

  PARSER_PORT: 3001
  APP_PORT: 6003
  MAPPER_PORT: 4000
  CONVERTER_PORT: 5000

  YARRRML_URL: http://yarrrml-parser:3001
  MAPPER_URL: http://rmlmapper:4000

  APP_MODE: development
  SSL_VERIFY: "False"

jobs:
  TestExamples:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Create .env for Docker Compose
        run: |
          cat <<EOF > .env
          PARSER_PORT=${PARSER_PORT}
          APP_PORT=${APP_PORT}
          MAPPER_PORT=${MAPPER_PORT}
          CONVERTER_PORT=${CONVERTER_PORT}
          YARRRML_URL=${YARRRML_URL}
          MAPPER_URL=${MAPPER_URL}
          APP_MODE=${APP_MODE}
          SSL_VERIFY=${SSL_VERIFY}
          EOF

      - name: Run app (Docker Compose)
        run: |
          docker compose -f docker-compose.develop.yml up -d --build
          echo "Waiting for services..."
          sleep 30
          docker compose ps

      - name: Parse mapping to YARRRML parser
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          curl -s -X POST "http://localhost:${APP_PORT}/api/yarrrmltorml" \
            -H "Content-Type: application/json" \
            -d "{\"mapping_url\":\"${MAPPING_URL}\"}" \
            -o example.rml

      - name: Join the method and the data meta graph
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          RESULT=$(curl -s -X POST "http://localhost:${APP_PORT}/api/createrdf" \
            -H "Content-Type: application/json" \
            -d "{\"mapping_url\":\"${MAPPING_URL}\"}")

          echo "$RESULT" | jq -r '.graph' > example.rdf

      - name: Print logs
        if: always()
        run: docker compose logs

      - name: Commit generated files
        uses: EndBug/add-and-commit@v9
        with:
          message: "updated example output"
          add: |
            example.rml
            example.rdf
          cwd: ./examples
